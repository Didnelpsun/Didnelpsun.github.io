---
layout: post
title:  "MySQL基础6"
date:   2020-03-05 17:02:00 +0800
categories: notes mysql base
tags: mysql MySQL 基础 临时表 派生表
excerpt: "临时表与派生表"
---

临时表和派生表属于一种比较复杂的使用技巧，所以需要更关注地对它们进行说明。

## 临时表

在MySQL中，临时表是一种特殊类型的表，它允许你存储一个临时结果集，可以在单个会话中多次重用。

当使用JOIN子句查询需要单个SELECT语句的数据是复杂的时候，临时表非常方便。 在这种情况下，我们就可以使用临时表来存储直接结果，并使用另一个查询来处理它。

MySQL临时表具有以下特殊功能：

+ 使用CREATE TEMPORARY TABLE语句创建临时表。请注意，在CREATE和TABLE关键字之间添加TEMPORARY关键字。
+ 当会话结束或连接终止时，MySQL会自动删除临时表。当您不再使用临时表时，也可以使用DROP TABLE语句来显式删除临时表。
+ 一个临时表只能由创建它的客户机访问。不同的客户端可以创建具有相同名称的临时表，而不会导致错误，因为只有创建临时表的客户端才能看到它。 但是，在同一个会话中，两个临时表不能共享相同的名称。
+ 临时表可以与数据库中的普通表具有相同的名称，不过原表就将无法使用。 例如，如果在一个数据库中创建一个名为employees的临时表，则现有的employees表将变得无法访问。 对employees表发出的每个查询现在都是指employees临时表。 当删除您临时表时，永久employees表可以再次访问。

<span style="color:red">警告：</span>即使临时表可以与永久表具有相同的名称，但不推荐。 因为这可能会导致混乱或意外的数据丢失。例如，如果与数据库服务器的连接丢失，并且你自动重新连接到服务器，则不能区分临时表和永久性表。 然后，你又发出一个DROP TABLE语句，这个时候删除的可能是永久表而不是临时表，这种结果是不可预料的。

### &emsp;创建

和普通的创建表并没什么区别，只需要将TEMPORARY关键字添加到CREATE TABLE语句的中间。

```sql
例如，以下语句创建一个临时表，按照收入存储前5名客户：
CREATE TEMPORARY TABLE top5customers
SELECT p.customerNumber,
       c.customerName,
       FORMAT(SUM(p.amount),2) total
FROM payments p
INNER JOIN customers c ON c.customerNumber = p.customerNumber
GROUP BY p.customerNumber
ORDER BY total DESC
LIMIT 5;
```

然后从top5customers临时表中查询数据，例如：`SELECT * FROM top5customers;`

### &emsp;删除

可以使用DROP TABLE语句来删除临时表，但最好添加TEMPORARY关键字如下：`DROP TEMPORARY TABLE 临时表名;`

DROP TEMPORARY TABLE语句仅删除临时表，而不是永久表。 当将临时表命名为永久表的名称相同时，它可以避免删除永久表的错误。

如果尝试使用DROP TEMPORARY TABLE语句删除永久表，则会收到一条错误消息，指出您尝试删除的表是未知的。

如果开发使用连接池或持久连接的应用程序，则不能保证临时表在应用程序终止时自动删除。因为应用程序使用的数据库连接可能仍然打开并放置在其他客户端使用的连接池中。 因此，当不再使用它们时马上删除临时表，这是一个很好的做法。

&emsp;

## 派生表

与临时表相比，派生表并不是由SQL定义的表，而是我们对于这种表的认识让我们知道这种表与一般的表不一样，则将这种表称为派生表。派生表是从SELECT语句返回的虚拟表。派生表类似于临时表，但是在SELECT语句中使用派生表比临时表简单得多，因为它不需要创建临时表的步骤。

派生表和子查询通常可互换使用。当SELECT语句的FROM子句中使用<span style="color:orange">独立子查询</span>时，我们将其称为派生表。

```sql
SELECT 列名
FROM(
    SELECT 列名 --被包裹的就是派生表
    FROM 表名 --
)派生表别名
WHERE 派生表别名.属性 条件;
```

派生表必须含有别名，不然会报错：Every derived table must have its own alias.

```sql
SELECT 
    productName, sales
FROM
    (SELECT 
        productCode, 
        ROUND(SUM(quantityOrdered * priceEach)) sales
    FROM
        orderdetails
    INNER JOIN orders USING (orderNumber)
    WHERE
        YEAR(shippedDate) = 2013
    GROUP BY productCode
    ORDER BY sales DESC
    LIMIT 5) top5products2013
INNER JOIN
    products USING (productCode);
```

关于里面有一个USING关键字，是MySQL独有的关键字，将在后面的连接中介绍。
