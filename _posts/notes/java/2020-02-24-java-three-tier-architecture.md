---
layout: post
title:  "三层架构"
date:   2019-11-14 14:25:47 +0800
categories: notes java other
tags: java 其他 三层架构 MVC DAO ORM
excerpt: "Java三层架构"
---

## 三层架构和MVC

很长一段时间中我们都会对应Spring的三层架构和MVC结构搞混，实际上它们并不是一个东西。

首先我们应该已经了解过了MVC是什么，它是一种设计模式目的是让HTML代码和业务逻辑代码分开，让代码看起来更加清晰，便于开发。M：model，V：view，C：controller。不论是MVC或者MVVM都是针对前端而言的。

而三层架构是一种分层思想，将开发模式分为了这三层，每个人根据自己的专长，开发不同的模块。

+ Dao（Persistance）：持久层，数据访问层，包括CRUD。
+ Service（Business）：业务处理层，对于一些业务进行判断。
+ Representation：表现层，接收用户请求和页面交互

Representation --> Service --> Dao

```java
//框架设计
//model
class Book{}

//dao
interface IBookDao{}
@Repository
class BookDao implements IBookDao{}

//service
interface IBookService{}
@Service
class BookService implements IBookService{
    @Autowired
    private IBookDao bookDao;
}

//controller
@Controller
class BookController{
    @Autowired
    private IBookService bookService;
}
```

&emsp;

## 业务层

采用事务脚本模式。将一个业务中所有的操作封装成一个方法，同时保证方法中所有的数据库更新操作，即保证同时成功或同时失败。避免部分成功部分失败引起的数据混乱操作。

业务层应该负责下面的问题：

+ 处理应用的业务逻辑和业务校验
+ 管理事务
+ 允许与其他层进行交互的接口
+ 管理业务级对象之间的依赖性
+ 加入了表现和持久层之间的灵活性，以便它们不需要彼此进行直接通信
+ 从表现层暴露上下文给业务层以获得业务服务
+ 管理从业务层到表现层的实现

### &emsp;事务脚本模式

事务脚本模式英文是Transaction Script，简写TS。事务脚本是一个方法——用户通过表现层的操作发送的请求进而形成的方法。这个模式就是指执行的业务与一组系统执行的操作(也就是脚本)与每个用户操作在逻辑上关联起来。建议跳过任何面向对象设计，把业务组件直接映射到所需的用户操作上。

在TS里，每个所需的用户操作的实现都是在物理事务的边界里从开始执行到结束。数据访问通常封装到一组组件里，组件通常会放入数据访问层。按照模式，TS没有包含任何面向对象设计的成分。通过TS建模的任何逻辑都是通过IF、WHILE和FOR等语言语法元素表达。

事务脚本比较适合于业务逻辑相对简单的情况下，我们之前没有谈过事务控制应该放在哪里，三层架构中也没有具体指定或者抽离一个事务层，所以事务控制在三层架构中任何一层都是可以的，但是一边拿都是控制在业务层的实现上的。事务脚本是属于领域逻辑模式中一种，将其置于与其他处理表现层和数据源层的类相对独立的类中。如果置于数据源层的类中，会失去事务脚本的控制原则，因为可能只控制了一部分业务逻辑，而其他的业务逻辑并没有控制到。

事务脚本一般由三个具体的类来构成，他们一般分别是Sevice,Dao,JavaBean, Service类主要用于组织业务逻辑，Dao类主要用于实现数据的存储，JavaBean主要用于数据的封装和实例化。

&emsp;

## 持久层

采用DAO模式，建立实体类和数据库表映射（ORM映射）。也就是哪个类对应哪个表，哪个属性对应哪个列。持久层的目的就是，完成对象数据和关系数据的转换。

### &emsp;DAO模式

DAO模式被应用于DAO层，而DAO就是Data Access Object即数据可访问对象，DAO层就是存放数据对象的层。

在面向对象设计过程中，有一些"套路”用于解决特定问题称为模式。DAO模式就是位于业务逻辑和持久化数据之间实现对持久化数据的访问，即对于数据库操作的封装。即应该将所有对数据源的访问操作进行抽象化后封装在一个公共API中。

DAO模式提供了访问关系型数据库系统所需操作的接口，将数据访问和业务逻辑分离对上层提供面向对象的数据访问接口。DAO模式做到了两个隔离：

+ 隔离了事务逻辑处理代码和数据访问代码，保护了数据，避免非法的操作污染数据。
+ 隔离了数据库的实现，DAO模式同SQL语言一样，只关心得到的数据，而不关心过程，采用面向接口编程，即使底层数据库实现类型或者种类变化上层处理也不会改变。

一个典型的DAO 模式主要由以下几部分组成：

1. DAO接口： 把对数据库的所有操作定义成抽象方法，可以提供多种实现。
2. DAO实现类： 针对不同数据库给出DAO接口定义方法的具体实现。
3. 实体类：用于存放与传输对象数据。
4. 数据库连接和关闭工具类： 避免了数据库连接和关闭代码的重复使用，方便修改。

DAO模式实际上包含了两个模式，一是Data Accessor（数据访问器），二是Data Object（数据对象），前者要解决如何访问数据的问题，而后者要解决的是如何用对象封装数据。

### &emsp;ORM

对象关系映射（Object Relational Mapping，简称ORM）模式是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。那么，到底如何实现持久化呢？一种简单的方案是采用硬编码方式，为每一种可能的数据库访问操作提供单独的方法。

这种方案存在以下不足：

1. 持久化层缺乏弹性。一旦出现业务需求的变更，就必须修改持久化层的接口。
2. 持久化层同时与域模型与关系数据库模型绑定，不管域模型还是关系数据库模型发生变化，都要修改持久化层的相关程序代码，增加了软件的维护难度。

ORM提供了实现持久化层的另一种模式，它采用映射元数据来描述对象关系的映射，使得ORM中间件能在任何一个应用的业务逻辑层和数据库层之间充当桥梁。Java典型的ORM中间件有:Hibernate，Mybatis等。

优点：

1. ORM使得我们的通用数据库交互变得简单易行，而且完全不用考虑该死的SQL语句。快速开发，由此而来。
2. 可以避免一些新手写SQL语句带来的性能问题。

缺点：

1. 性能有所牺牲，不过现在的各种ORM框架都在尝试各种方法，比如缓存，延迟加载登来减轻这个问题。效果很显著。
2. 对于个别复杂查询，ORM仍然力不从心，为了解决这个问题，ORM一般也支持写raw sql。

&emsp;

## 表现层（JSP、Servlet等）

采用MVC模式：

+ M称为模型，也就是实体类。用于数据的封装和数据的传输。
+ V为视图，也就是GUI组件，用于数据的展示。
+ C为控制，也就是事件，用于流程的控制。

&emsp;

## 设计原则

业务层接口的设计原则：一个实体类一个接口，一次提交一个业务方法。业务方法的参数来自表现层。

持久层接口的设计原则：一个实体类一个接口，一次数据库操作一个持久方法。

&emsp;

## 常用解决方案

SSH框架

+ 业务层——Spring
+ 表现层——Struts
+ 持久层——Hibernate

SSM框架

+ 业务层——Spring
+ 表现层——SpringMVC
+ 持久层——MyBatis
